<html>

<head>
    <meta charset="UTF-8">
    <title>好車大聯盟~賀圖產生器</title>
</head>
<link rel="stylesheet" href="styles.css">

<body>
    <script src="https://unpkg.com/gifler@0.1.0/gifler.min.js"></script>
    <script src="gif.js"></script>
    <script src="GIFEncoder.js"></script>
    <div>
        <canvas class='cvs' id='test2'></canvas>
    </div>
    <div class="inputa" style="margin-top: 20px; padding-left: 20px;">
        <br>
        <p>
            請輸入車行名稱<br>
            <span> <input style="font-size: 30px;"id='name' value="最多七個的喔喔" maxlength="7" placeholder="車行名稱(最多七字)" /></span>
        </p>
    </div>
    <div class="inputa">
        <span>
            <form hidden="true">
                <br>字體大小
                <select id="fontSize" name="YourLocation">
                    　<option value="50">50</option>
                    　<option value="60">60</option>
                    　<option value="70">70</option>
                    　<option value="80">80</option>
                    　<option value="90">90</option>
                </select>
            </form>
        </span>
    </div>
    <div class="inputa">
        <form hidden="true">
            請選擇文字樣式<br><br>
            <input style="WIDTH: 30px; HEIGHT: 30px" id="mode1" type="radio" name="Fruit" value="1" checked="true"> 內文
            <input style="WIDTH: 30px; HEIGHT: 30px" id="mode2" type="radio" name="Fruit" value="2"> 外框
            <input style="WIDTH: 30px; HEIGHT: 30px" id="mode3" type="radio" name="Fruit" value="3">內文+外框
        </form>
    </div>
    <div class="inputa">
        <br> 請選擇文字顏色
        <select id="colorContent" style="font-size: 25px ; padding-left: 15px;; " name="colorContent" size="1">
            <option value="White" style="background:white;">White</option>
            <option value="Black" style="background:black;">Black</option>
            <option value="Yellow" style="background:yellow;">Yellow</option>
            <option value="Gold" style="background:Gold;">Gold </option>
            <option value="Orange" style="background:orange;">Orange</option>
            <option value="GoldenRod" style="background:GoldenRod;">GoldenRod </option>
            <option value="Tomato" style="background:Tomato;">Tomato </option>
            <option value="Red" style="background:red;">Red</option>
            <option value="OrangeRed" style="background:OrangeRed;">OrangeRed </option>
            <option value="Brown" style="background:brown;">Brown</option>
            <option value="Maroon" style="background:maroon;">Maroon</option>
            <option value="LightSkyBlue" style="background:LightSkyBlue;">LightSkyBlue </option>
            <option value="Cyan" style="background:Cyan;">Cyan</option>
            <option value="SkyBlue" style="background:SkyBlue;">SkyBlue </option>
            <option value="CornflowerBlue" style="background:CornflowerBlue;">CornflowerBlue </option>
            <option value="Blue" style="background:blue;">Blue</option>
            <option value="Navy" style="background:navy;">Navy</option>
            <option value="SlateBlue" style="background:SlateBlue;">SlateBlue </option>
            <option value="Magenta" style="background:Magenta;">Magenta </option>
            <option value="BlueViolet" style="background:BlueViolet ;">BlueViolet </option>
            <option value="Purple" style="background:purple;" SELECTED>Purple</option>
            <option value="LightGreen" style="background:LightGreen;">LightGreen </option>
            <option value="YellowGreen" style="background:YellowGreen;">YellowGreen </option>
            <option value="Chartreuse" style="background:Chartreuse;">Chartreuse </option>
            <option value="SpringGreen" style="background:SpringGreen;">SpringGreen </option>
            <option value="LimeGreen" style="background:LimeGreen;">LimeGreen</option>
            <option value="Green" style="color:green;">Green</option>
        </select>
        <br> <br>
    </div>

    <br>
    <div class="inputa">
        <br>請選擇外框顏色
        <select id="colorFrame" style="font-size:25px; padding-left: 15px;" name="colorFrame" size="1">
            <option value="White" style="background:white;">White</option>
            <option value="Black" style="background:black;">Black</option>
            <option value="Yellow" style="background:yellow;">Yellow</option>
            <option value="Gold" style="background:Gold;">Gold </option>
            <option value="Orange" style="background:orange;">Orange</option>
            <option value="GoldenRod" style="background:GoldenRod;">GoldenRod </option>
            <option value="Tomato" style="background:Tomato;">Tomato </option>
            <option value="Red" style="background:red;">Red</option>
            <option value="OrangeRed" style="background:OrangeRed;">OrangeRed </option>
            <option value="Brown" style="background:brown;">Brown</option>
            <option value="Maroon" style="background:maroon;">Maroon</option>
            <option value="LightSkyBlue" style="background:LightSkyBlue;">LightSkyBlue </option>
            <option value="Cyan" style="background:Cyan;" SELECTED>Cyan</option>
            <option value="SkyBlue" style="background:SkyBlue;">SkyBlue </option>
            <option value="CornflowerBlue" style="background:CornflowerBlue;">CornflowerBlue </option>
            <option value="Blue" style="background:blue;">Blue</option>
            <option value="Navy" style="background:navy;">Navy</option>
            <option value="SlateBlue" style="background:SlateBlue;">SlateBlue </option>
            <option value="Magenta" style="background:Magenta;">Magenta </option>
            <option value="BlueViolet" style="background:BlueViolet ;">BlueViolet </option>
            <option value="Purple" style="background:purple;">Purple</option>
            <option value="LightGreen" style="background:LightGreen;">LightGreen </option>
            <option value="YellowGreen" style="background:YellowGreen;">YellowGreen </option>
            <option value="Chartreuse" style="background:Chartreuse;">Chartreuse </option>
            <option value="SpringGreen" style="background:SpringGreen;">SpringGreen </option>
            <option value="LimeGreen" style="background:LimeGreen;">LimeGreen</option>
            <option value="Green" style="color:green;">Green</option>
        </select>
        <br><br>
    </div>
    <br>
    <div class="inputa">
        <br>請選擇特效<br><br>
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode1" type="checkbox" name="vehicle1" value="Bike">跑馬燈
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode2" type="checkbox" name="vehicle2" value="Car"> 文字放大縮小
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode3" type="checkbox" name="vehicle3" value="Boat" hidden="true"> <br><br>
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode4" type="checkbox" name="vehicle3" value="Boat"> 邊框閃爍
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode5" type="checkbox" name="vehicle3" value="Boat"> 內文+邊框閃爍
        <input style="WIDTH: 30px; HEIGHT: 30px" id="seMode6" type="checkbox" name="vehicle3" value="Boat"> 文字上下跳
        <br><br>
    </div>
    <div id="loadingGif" style="padding-top: 20px;padding-bottom: 20px;" hidden="true">
        <img src="images/ZZ5H.gif" style="width: 100;height: 100;"> 圖片產生中...請稍後
    </div>
    <div>

        <button class="btn" id='btn'>生成gif</button>
        <button class="btn" id='reload'>重設</button>
    </div>

</body>

<script>
    var input = document.getElementById('name');
    var canvas = document.getElementById('test2');
    var fontSize = document.getElementById('fontSize');
    var colorContent = document.getElementById('colorContent');
    var colorFrame = document.getElementById('colorFrame');
    var mode1 = document.getElementById('mode1');
    var mode2 = document.getElementById('mode2');
    var mode3 = document.getElementById('mode3');
    var seMode1 = document.getElementById('seMode1');
    var seMode2 = document.getElementById('seMode2');
    var seMode3 = document.getElementById('seMode3');
    var seMode4 = document.getElementById('seMode4');
    var seMode5 = document.getElementById('seMode5');
    var seMode6 = document.getElementById('seMode6');
    var loadingGif = document.getElementById('loadingGif');
    canvas.width = 300;
    canvas.height = 400;
    var ctx2 = canvas.getContext('2d');
    // use external library to parse and draw gif animation
    var img = new Image();
    img.src = 'images/h03.png';
    var btn = document.getElementById('btn');
    var gif = new GIF({
        workers: 1,
        quality: 10,
        repeat: 0,
        debug: true
    });
    // var img2 = new Image();
    // img2.src = 'images/h03.png';
    var count = 0;
    var time = 0;
    var dTime = 100;
    var array = [];
    var arrayD = [];
    var fontArraySize = 0;
    var intFontSize = 70;

    function onDrawFrame(ctx, frame) {
        if (count > 0) {
            dTime = (Date.now() - time)
        }

        time = Date.now();
        // update canvas size
        canvas.width = frame.width;
        canvas.height = frame.height;

        ctx.drawImage(frame.buffer, 0, 0);
        //強制轉換字體大小
        if (input.value.length > 6) {
            intFontSize = 45;
        } else if (input.value.length > 5) {
            intFontSize = 55;
        } else if (input.value.length > 4) {
            intFontSize = 60;
        } else {
            intFontSize = 70;
        }
        //字型大小
        ctx.font = "bold " + intFontSize + "px serif";


        var ss = input.value.split('');
        fontArraySize = ss.length;
        if (fontArraySize > 0) {
            var pos = 0;
            ss.forEach(element => {
                //因為看起來文字部分占了2/4
                var widthBase = frame.width / 4;

                // var FontX = widthBase * 2 / fontArraySize * pos + (fontSize.value * 0.8) + widthBase;
                var FontX = 0
                if (ss.length > 6) {
                    FontX = widthBase + (widthBase * 2 / ss.length * pos) - 40 + (pos * 3);
                } else if (ss.length > 5) {
                    FontX = widthBase + (widthBase * 2 / ss.length * pos) - 40 + (pos * 4);
                } else if (ss.length > 4) {
                    widthBase = widthBase - 10
                    console.log(widthBase + "+" + widthBase + "*2/" + ss.length + "*" + pos);
                    FontX = widthBase + (widthBase * 2 / ss.length * pos) - 20 + (pos * 7);
                } else {
                    FontX = widthBase + (widthBase * 2 / ss.length * pos) - 15
                }


                var FontY = frame.height - 40;




                if (seMode2.checked) {
                    FontResize(ctx, count, pos)
                }

                // if (mode1.checked || mode3.checked) {
                if (seMode1.checked)
                    HorseRunning(ctx, pos, count)
                else if (seMode3.checked)
                    ContentFlicker(ctx, count)
                else if (seMode5.checked) {
                    ALLFlickerFill(ctx, count)
                } else
                    ctx.fillStyle = colorContent.value;

                if (seMode6.checked)
                    FontJump(ctx, element, FontX, FontY, pos, count)
                else
                    ctx.fillText(element, FontX, FontY);
                // }

                // if (mode2.checked || mode3.checked) {

                ctx.lineWidth = "1";
                if (seMode4.checked)
                    FrameFlicker(ctx, count)
                else if (seMode5.checked) {
                    ALLFlicker(ctx, count)
                } else
                    ctx.strokeStyle = colorFrame.value;

                if (seMode6.checked)
                    FontJumpStroke(ctx, element, FontX, FontY, pos, count)
                else
                    ctx.strokeText(element, FontX, FontY);
                // }

                pos++;
            });

        }

        if (count <= 11) {
            //用時間差來取得gif本來的延遲
            gif.addFrame(canvas, {
                delay: 300
            });
            // array.push(canvas)
            if (count == 11) {
                ok();
            }
        }
        count++;
        // 或者从canvas的上下文复制像素信息

    }

    function ok() {
        console.log(281)
            // var i = 0;
            // array.forEach(element => {
            //     gif.addFrame(element,{delay:70});
            //     i++;
            // });
        gif.addFrame(ctx2, {
            copy: true
        });
        console.log(gif.length)
            // gif.removeChild()
    }

    //文字上下動 stroke
    function FontJumpStroke(ctx, element, FontX, FontY, pos, count) {
        console.log(FontX, pos, count % 5);
        var mX = 0;
        if (count % fontArraySize == pos) {
            mX = FontY - 60
        } else {
            mX = FontY
        }
        ctx.strokeText(element, FontX, mX);
    }

    //文字上下動 fill
    function FontJump(ctx, element, FontX, FontY, pos, count) {
        var mX = 0;
        if (count % fontArraySize == pos) {
            mX = FontY - 60
        } else {
            mX = FontY
        }
        ctx.fillText(element, FontX, mX);
    }

    //內文 + 邊框 閃爍
    function ALLFlickerFill(ctx, count) {
        if (count % 2 == 0) {
            ctx.fillStyle = "yellow";

        } else {
            ctx.fillStyle = "black";

        }
    }
    //內文 + 邊框 閃爍
    function ALLFlicker(ctx, count) {
        if (count % 2 == 0) {
            ctx.strokeStyle = "yellow";
        } else {
            ctx.strokeStyle = "black";
        }
    }

    //內文閃爍
    function ContentFlicker(ctx, count) {
        if (count % 2 == 0) {
            ctx.fillStyle = "yellow";
        } else {
            ctx.fillStyle = "black";
        }
    }

    //邊框閃爍
    function FrameFlicker(ctx, count) {
        if (count % 2 == 0) {
            ctx.strokeStyle = "red";
        } else {
            ctx.strokeStyle = "white";
        }
    }

    //閃爍
    function Flicker(ctx, count) {
        if (count % 2 == 0) {
            ctx.fillStyle = "rgb(122,169,42)";
        } else {
            ctx.fillStyle = "rgb(255,255,255)";
        }
    }

    //文字放大縮小
    function FontResize(ctx, count, pos) {
        if (count % fontArraySize == pos) {
            ctx.font = "bold " + (intFontSize + 30) + "px serif";
        } else {
            ctx.font = "bold " + intFontSize + "px serif";
        }

    }

    var horseColor = ['red', 'orange', 'yellow', 'green', 'blue', '#4b0080', 'purple']
        //人生跑馬燈
    function HorseRunning(ctx, pos, count) {
        ctx.fillStyle = horseColor[Math.abs((count % fontArraySize) - pos)];
    }



    var mBlob = null;



    //新的gif生成
    function gifFactory() {
        if (mBlob == null) {

            // gif.addFrame(ctx2, { copy: true });
            gif.on('finished', function(blob) {

                // 这里的blob就是gif图片blod格式信息
                mBlob = blob;
                openURL();
                // window.location.reload();
            });
            gif.render();
        } else {
            openURL();
        }
    }

    //共用
    function openURL() {
        //下载动作
        var el = document.createElement('a');
        el.href = URL.createObjectURL(mBlob);
        el.download = input.value; //设置下载文件名称
        document.body.appendChild(el);
        var evt = document.createEvent("MouseEvents");
        evt.initEvent("click", false, false);
        el.dispatchEvent(evt);
        document.body.removeChild(el);

        // window.open(URL.createObjectURL(mBlob));
    }
    gifler('images/b01.gif').frames(canvas, onDrawFrame);
    btn.onclick = () => {
        // console.log("clickTimes:" + clickTimes)
        loadingGif.hidden = false;

        gifFactory();

    }
    reload.onclick = () => {
        window.location.reload();
    }
</script>

</html>